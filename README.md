# 📷 写真ファイル管理システム

Googleドライブの写真ファイルを自動解析し、Googleスプレッドシートに整理するWebアプリケーションです。

## ⚠️ 重要：セキュリティ注意事項

このリポジトリには機密情報は含まれていませんが、使用前に**必ず**以下の設定が必要です：

1. **Google Cloud Console**でプロジェクトを作成
2. **OAuth 2.0認証情報**を取得
3. **環境変数**を設定（`.env.template`を参照）

詳細は [`SETUP_GUIDE.md`](SETUP_GUIDE.md) を参照してください。

## 🚀 VSCodeでの起動方法

### 方法1: 実行ボタン（▶）を使用 【推奨】

1. VSCodeで `start_server.py` ファイルを開く
2. 右上の **実行ボタン（▶）** をクリック
3. 自動的にサーバーが起動し、ブラウザが開きます

### 方法2: デバッグメニューから起動

1. VSCodeのメニューから **実行 > デバッグの開始** を選択
2. **🚀 写真管理システム サーバー起動** を選択
3. サーバーが起動します

### 方法3: コマンドパレットから起動

1. `Cmd+Shift+P` （Windows: `Ctrl+Shift+P`）でコマンドパレットを開く
2. **Tasks: Run Task** を選択
3. **🚀 サーバー起動 (Python)** を選択

## 🌐 アクセス方法

サーバー起動後、自動的にブラウザが開きます。  
手動でアクセスする場合: **http://localhost:3000**

## 🎯 機能概要

### 🔒 **セキュリティ重視の設計**
- **ゼロ脆弱性**: ExcelJSライブラリで安全なExcel処理
- **APIキー完全保護**: サーバーサイドでの機密情報管理
- **バックエンド経由API**: 直接API呼び出しを排除

### 📁 **ファイル管理機能**
- **フォルダ選択**: Googleドライブから任意のフォルダを選択（階層対応）
- **写真ファイル自動検出**: JPEG、JPG、PNG、HEIC形式に対応
- **ファイル名解析**: 規定の命名規則に従ってファイル名を自動解析
- **番号順ソート**: スプレッドシート書き込み時に自動的に番号順（1,2,3...）に整列

### 📊 **データ処理機能**
- **マッピングテーブル対応**: 素材ID・加工IDの自動変換
- **重量単位統一**: g/kg両対応での自動計算
- **写真区分フィルター**: 処理対象外（M区分）ファイルの自動除外
- **スプレッドシート連携**: 解析結果を左端シートに自動書き込み

### 🎨 **ユーザビリティ**
- **直感的UI**: ステップバイステップの分かりやすいインターフェース
- **リアルタイムプレビュー**: ファイル解析結果の即座確認
- **詳細なログ**: デバッグ情報による透明性確保

## 📋 ファイル名規則

このシステムは以下の命名規則に従った写真ファイルを処理します：

```
番号_部品名_重量_単位_素材ID_加工ID_写真区分_特記事項.拡張子
```

### 例
- `001_ねじ_10.1_g_ol01_pr01_P_0.jpg`
- `002_ワッシャー_5.2_g_st02_nc01_P_1.png`
- `003_ナット_15.0_g_al03_mc02_M_0.jpeg` (処理対象外)

### 各項目の説明
- **番号**: ファイルの並び順（自動的に昇順ソート）
- **部品名**: 部品の名称
- **重量**: 数値（小数点可）
- **単位**: `g`または`kg`（自動で両方の単位に変換）
- **素材ID**: 素材マッピングテーブルで変換される
- **加工ID**: 加工マッピングテーブルで変換される
- **写真区分**: `P`（処理対象）/ `M`（処理対象外、自動除外）
- **特記事項**: `0`（なし）/ `1`（あり）

### 📊 マッピングテーブル仕様

**素材ID対応表** (Excel形式):
| 素材ID | 素材名 | 素材区分 |
|--------|--------|----------|
| ol01   | 鉄鋼   | 金属     |
| st02   | ステンレス | 金属  |

**加工ID対応表** (Excel形式):
| 加工ID | 加工方法名 |
|--------|------------|
| pr01   | プレス加工 |
| nc01   | NC加工     |

## 🚀 セットアップ手順

### 1. Google Cloud Console設定

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成または既存プロジェクトを選択
3. 以下のAPIを有効化：
   - Google Drive API
   - Google Sheets API

### 2. 認証情報の設定

1. **APIキーの作成**:
   - 「APIとサービス」→「認証情報」
   - 「認証情報を作成」→「APIキー」
   - 作成されたAPIキーをコピー

2. **OAuth 2.0クライアントIDの作成**:
   - 「認証情報を作成」→「OAuth クライアント ID」
   - アプリケーションタイプ: 「ウェブアプリケーション」
   - 承認済みのJavaScriptドメインを追加（例：`http://localhost:8000`）
   - 作成されたクライアントIDをコピー

### 3. 依存関係のインストール

```bash
cd "/Users/nagai/Downloads/研究関係/05_システム"
npm install
```

**安全な依存関係構成:**
- ✅ **ExcelJS**: セキュアなExcel処理ライブラリ
- ✅ **Express**: 高速Webフレームワーク  
- ✅ **Google APIs**: 公式GoogleライブラリDeep

```json
{
  "dependencies": {
    "exceljs": "^4.4.0",      // xlsx代替（セキュリティ強化）
    "express": "^4.18.2",
    "googleapis": "^128.0.0",
    "cors": "^2.8.5",
    "multer": "^1.4.5-lts.1",
    "dotenv": "^16.3.1"
  }
}
```

### 4. 環境変数の設定

`.env`ファイルを作成し、Google Cloud Consoleで取得した値を設定：

```bash
GOOGLE_API_KEY=あなたの実際のAPIキー
GOOGLE_CLIENT_ID=あなたの実際のクライアントID
```

**🚨 セキュリティ重要事項:**
- `.env`ファイルは絶対にGitにコミットしない
- APIキーはサーバーサイドでのみ使用

### 5. サーバー起動

**VSCodeでの起動（推奨）:**
```bash
# start_server.py を開いて実行ボタン（▶）をクリック
python start_server.py
```

**またはターミナル:**
```bash
npm start
# または
node server.js
```

### 6. アクセス

サーバー起動後、ブラウザで以下にアクセス：
**http://localhost:3000**

## 🔒 セキュリティ機能

### ✅ 実装済みセキュリティ対策
- **ゼロ脆弱性**: `npm audit`で確認済み
- **ExcelJS採用**: 安全なExcel処理ライブラリ
- **APIキー保護**: サーバーサイド環境変数で管理
- **バックエンド経由API**: 直接API呼び出しを排除
- **セッション管理**: 1時間タイムアウト

### 🛡️ セキュリティチェック
```bash
npm audit          # 脆弱性スキャン
npm audit fix      # 安全な修正を適用
```

## 📱 使用方法

### ステップ1: 認証
1. ブラウザで`http://localhost:8000`にアクセス
2. 「Googleアカウントで認証」ボタンをクリック
3. Googleアカウントでサインイン
4. 必要な権限を許可

### ステップ2: フォルダ選択
1. 「フォルダを選択」ボタンをクリック
2. 写真ファイルが保存されているGoogleドライブのフォルダを選択
3. 検出された写真ファイルを確認

### ステップ3: スプレッドシート選択
1. 「スプレッドシートを選択」ボタンをクリック
2. データを書き込むGoogleスプレッドシートを選択
3. 既存データと書き込み位置を確認

### ステップ4: データ処理
1. 「データを処理してスプレッドシートに書き込む」ボタンをクリック
2. 処理の進行状況を確認
3. 結果を確認

## 📊 スプレッドシート形式

データは以下の列に書き込まれます：

| 列 | 項目 | 説明 |
|---|------|------|
| A | 部品名 | ファイル名から抽出された部品名 |
| B | 重量 | 数値として抽出された重量 |
| C | 単位 | 重量の単位 |
| D | 素材ID | 素材を識別するID |
| E | 加工ID | 加工方法を識別するID |
| F | 写真区分 | 写真の種類 |
| G | 特記事項 | 追加情報（任意） |

データは2行目から書き込まれ、既存のデータがある場合は適切な位置に追加されます。

## 🛠️ トラブルシューティング

### よくある問題

1. **「認証が必要です」エラー**
   - Google Cloud Consoleで正しくAPIが有効化されているか確認
   - OAuth設定で適切なドメインが登録されているか確認

2. **「フォルダが見つかりません」**
   - Googleドライブにフォルダが存在するか確認
   - 適切な権限でアクセスしているか確認

3. **「ファイル名の形式が正しくありません」**
   - ファイル名が規定の形式に従っているか確認
   - アンダーバー（_）で正しく区切られているか確認

4. **HTTPSエラー**
   - ローカル開発時はHTTPでも動作しますが、本番環境ではHTTPS必須
   - OAuth設定でHTTPSドメインを使用

### デバッグ情報

ブラウザの開発者ツール（F12）のコンソールでエラー詳細を確認できます。

## 🎨 カスタマイズ

### UI色テーマの変更
`styles.css`の以下の部分を編集：
```css
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
}
```

### ファイル名形式の変更
`file-parser.js`の`parseFileName`メソッドを修正することで、異なるファイル名形式に対応可能です。

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 サポート

問題が発生した場合は、以下の情報を含めてお知らせください：
- ブラウザの種類とバージョン
- エラーメッセージ
- 実行環境（ローカル/本番）
- 処理しようとしたファイル名の例

---

## 📚 技術仕様

### 使用技術
- **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
- **API**: Google Drive API v3, Google Sheets API v4
- **認証**: OAuth 2.0

### 対応ブラウザ
- Chrome 80+
- Firefox 75+
- Safari 13+
- Edge 80+

### ファイルサイズ制限
- Google Drive APIの制限に準拠
- 推奨：1フォルダあたり1000ファイル以下

### セキュリティ
- OAuth 2.0による安全な認証
- 最小限の権限のみを要求
- クライアントサイドでの処理（サーバーにデータ保存なし）

---

*最終更新日: 2025年10月7日*