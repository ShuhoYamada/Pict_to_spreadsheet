# 🔒 セキュア写真ファイル管理システム 使用手順

## ⚡ クイックスタート

### 1. 依存関係のインストール
```bash
cd "/Users/nagai/Downloads/研究関係/05_システム"
npm install
```

**✅ 最新版の特徴:**
- **ExcelJS採用**: セキュリティ脆弱性のあったxlsxライブラリから安全なExcelJSに移行
- **ゼロ脆弱性**: `npm audit`で確認済みの安全な依存関係
- **ファイル番号順ソート**: スプレッドシート書き込み時に自動的に番号順（1,2,3...）に整列

### 2. 環境変数の設定
`.env`ファイルを編集して、Google Cloud Consoleで取得した値を設定：
```bash
GOOGLE_API_KEY=あなたの実際のAPIキー
GOOGLE_CLIENT_ID=あなたの実際のクライアントID
```

### 3. サーバー起動
**推奨方法（VSCode）:**
```bash
# VSCodeで start_server.py を開いて実行ボタン（▶）をクリック
python start_server.py
```

**または従来方法:**
```bash
npm start
```

### 4. アクセス
ブラウザで `http://localhost:3000` にアクセス

## 🛡️ セキュリティ機能

### ✅ 実装されたセキュリティ対策

1. **依存関係の安全性確保**
   - xlsxライブラリの脆弱性（GHSA-4r6h-8v6p-xvw6, GHSA-5pgg-2g8v-p4x9）を解決
   - ExcelJSライブラリで安全なExcel処理を実現
   - 定期的な脆弱性スキャンで`npm audit: 0 vulnerabilities`を維持

2. **APIキーの完全隠蔽**
   - APIキーはサーバーサイドの環境変数に保存
   - フロントエンドに一切露出されない

3. **バックエンド経由のAPI通信**
   - すべてのGoogle APIs呼び出しはサーバー経由
   - クライアントから直接APIを叩かない

4. **Git管理の安全性**
   - `.gitignore`で機密ファイルを除外
   - 誤ってAPIキーをコミットするリスクを回避

5. **セッション管理**
   - ブラウザのセッションストレージで認証状態管理
   - 1時間でタイムアウト

### 🚫 セキュリティリスクを回避

- ❌ APIキーをJavaScriptファイルに直接記述
- ❌ フロントエンドから直接Google APIsを呼び出し
- ❌ 機密情報をGitリポジトリにコミット

## 📋 使用手順

1. **認証**
   - 「セキュアな認証が必要です」ボタンをクリック
   - Google認証ページに自動リダイレクト
   - 権限を許可してサービスに戻る

2. **マッピングファイル設定**
   - 「素材ID対応表を選択」ボタンで素材マッピングファイルを選択
   - 「加工ID対応表を選択」ボタンで加工マッピングファイルを選択
   - **対応するヘッダー名**: 
     - 素材: `素材ID`, `素材名`, `素材区分`
     - 加工: `加工ID`, `加工方法` または `加工方法名`

3. **フォルダ選択**
   - 「フォルダを選択」ボタンをクリック
   - Googleドライブのフォルダ一覧から選択（階層対応）

4. **スプレッドシート選択**
   - 「スプレッドシートを選択」ボタンをクリック
   - 書き込み先スプレッドシートを選択（自動的に左端のシートに書き込み）

5. **データ処理**
   - 「データを処理してスプレッドシートに書き込む」をクリック
   - **自動機能**:
     - ファイル名の番号順ソート（1,2,3,4...）
     - 素材ID・加工IDの自動変換
     - 重量の単位統一（g/kg両対応）
     - 写真区分Mファイルの自動除外

## 🔧 開発者向け設定

### 依存関係について
```json
{
  "dependencies": {
    "exceljs": "^4.4.0",     // 安全なExcel処理（xlsxから移行）
    "express": "^4.18.2",    // Webサーバー
    "googleapis": "^128.0.0", // Google APIs
    "cors": "^2.8.5",        // CORS対応
    "multer": "^1.4.5-lts.1", // ファイルアップロード
    "dotenv": "^16.3.1"      // 環境変数管理
  }
}
```

### Google Cloud Console設定
1. プロジェクト作成：`photo-file-manager`
2. API有効化：Google Drive API, Google Sheets API
3. 認証情報作成：
   - APIキー（サーバーIP制限推奨）
   - OAuth 2.0クライアントID
   - 承認済みリダイレクトURI：`http://localhost:3000/auth/callback`

### 最新の技術スタック
- **フロントエンド**: ExcelJS（CDN）, Vanilla JavaScript
- **バックエンド**: Node.js + Express
- **Excel処理**: ExcelJS（セキュリティ強化版）
- **認証**: Google OAuth 2.0
- **API**: Google Drive API, Google Sheets API

### 本番環境での追加セキュリティ
- HTTPS必須
- CORS設定の厳格化
- レート制限の実装
- ログ監視の設定
- 定期的な`npm audit`によるセキュリティチェック

## 🚨 重要な注意事項

1. **`.env`ファイルは絶対に公開しない**
2. **本番環境ではHTTPS使用必須**
3. **定期的にAPIキーをローテーション**
4. **不要な権限は要求しない**
5. **依存関係のセキュリティを定期チェック**
   ```bash
   npm audit  # 脆弱性スキャン
   npm update # 安全なバージョンにアップデート
   ```

## 📊 セキュリティ状況

- **脆弱性**: ✅ 0件（`npm audit`確認済み）
- **依存関係**: ✅ 最新の安全版
- **Excel処理**: ✅ ExcelJSで安全性確保
- **API通信**: ✅ バックエンド経由で保護済み

## 🔄 更新履歴

- **2025年10月**: ExcelJSへの移行、セキュリティ脆弱性完全解決
- **機能追加**: ファイル番号順ソート、マッピングテーブル対応
- **UI改善**: イベントリスナー重複防止、デバッグ情報強化

このセキュアな実装により、APIキー漏洩のリスクを完全に排除し、安全にGoogle APIsを利用できます。